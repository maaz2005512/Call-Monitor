<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âš¡ Vapi Monitor</title>
    <style>
        /* ðŸ“± MOBILE LAYOUT FIXES */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: #000; 
            color: white; 
            margin: 0; 
            padding: 0;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100dvh; /* FIX: Dynamic height handles mobile address bars */
            overflow: hidden; /* Prevents scroll bounce */
        }

        .card { 
            background: #111; 
            border: 1px solid #333; 
            padding: 24px; 
            border-radius: 24px; 
            width: 85%; 
            max-width: 380px; 
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        /* Audio Visualizer */
        .visualizer { display: flex; justify-content: center; align-items: flex-end; height: 50px; gap: 6px; margin: 25px 0; }
        .bar { width: 8px; background: #4ade80; border-radius: 99px; height: 5px; transition: height 0.05s ease; }

        /* Controls */
        select { 
            width: 100%; padding: 16px; margin-top: 10px; border-radius: 12px; 
            font-size: 16px; border: 1px solid #444; background: #222; color: #fff; 
            appearance: none; text-align: center;
        }
        
        button { 
            width: 100%; padding: 18px; margin-top: 15px; border-radius: 14px; 
            font-size: 17px; font-weight: 700; border: none; cursor: pointer; 
            transition: transform 0.1s;
        }
        .btn-start { background: #2563eb; color: white; }
        .btn-sync { background: #dc2626; color: white; display: none; }
        button:active { transform: scale(0.96); opacity: 0.9; }

        .stat-row { 
            display: flex; justify-content: space-between; font-size: 11px; 
            color: #666; margin-top: 20px; font-family: monospace; text-transform: uppercase; letter-spacing: 1px;
        }
    </style>
</head>
<body>

<div class="card">
    <div style="color: #888; font-size: 12px; margin-bottom: 5px; font-weight: 600;">LIVE STREAM</div>
    <h2 style="margin: 0; font-weight: 800; letter-spacing: -0.5px;">Live Call</h2>

    <div class="visualizer" id="visualizer">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        <div class="bar"></div><div class="bar"></div>
    </div>

    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 8px;">SAMPLE RATE TUNER</label>
    <select id="rateSelect" onchange="restartEngine()">
        <option value="48000">48,000 Hz (Max)</option>
        <option value="44100">44,100 Hz (High Def)</option>
        <option value="32000" selected>32,000 Hz (The Middle Way)</option>
        <option value="24000">24,000 Hz (Turbo)</option>
        <option value="16000">16,000 Hz (Standard)</option>
    </select>

    <button id="mainBtn" class="btn-start" onclick="startCall()">ðŸ”´ Connect</button>
    <button id="syncBtn" class="btn-sync" onclick="forceSync()">âš¡ Reset Latency</button>

    <div class="stat-row">
        <span id="bufferStat">Buffer: 0ms</span>
        <span id="statusText">Ready</span>
    </div>
</div>

<script>
    let socket = null;
    let audioCtx = null;
    let nextTime = 0;
    let wssUrl = null;
    let analyser;

    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        wssUrl = params.get('call');
        if (!wssUrl) {
            document.getElementById('mainBtn').innerText = "âŒ Missing Link";
            document.getElementById('mainBtn').disabled = true;
            document.getElementById('mainBtn').style.background = "#333";
        }
    };

    function startCall() {
        if (!wssUrl) return;

        // Init Audio Context with selected rate
        const rate = parseInt(document.getElementById('rateSelect').value);
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: rate });
        
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 64;
        analyser.connect(audioCtx.destination);

        socket = new WebSocket(wssUrl);
        socket.binaryType = "arraybuffer";

        document.getElementById('mainBtn').innerText = "Connecting...";

        socket.onopen = () => {
            document.getElementById('mainBtn').style.display = "none";
            document.getElementById('syncBtn').style.display = "block";
            document.getElementById('statusText').innerText = "CONNECTED";
            document.getElementById('statusText').style.color = "#4ade80";
            nextTime = audioCtx.currentTime + 0.1; 
            animate();
        };

        socket.onmessage = (event) => {
            if (event.data instanceof ArrayBuffer) playChunk(event.data);
        };

        socket.onclose = () => {
            document.getElementById('statusText').innerText = "ENDED";
            document.getElementById('statusText').style.color = "#666";
            document.getElementById('syncBtn').innerText = "Call Ended";
            document.getElementById('syncBtn').disabled = true;
            document.getElementById('syncBtn').style.background = "#333";
        };
    }

    function playChunk(arrayBuffer) {
        const int16 = new Int16Array(arrayBuffer);
        const float32 = new Float32Array(int16.length);
        for (let i = 0; i < int16.length; i++) float32[i] = int16[i] / 32768; 

        // Use current selected rate for buffer
        const selectedRate = parseInt(document.getElementById('rateSelect').value);
        const buffer = audioCtx.createBuffer(1, float32.length, selectedRate);
        buffer.getChannelData(0).set(float32);

        // Latency Killer
        if (nextTime < audioCtx.currentTime) nextTime = audioCtx.currentTime;
        if (nextTime > audioCtx.currentTime + 0.2) nextTime = audioCtx.currentTime + 0.05; // Tight sync

        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(analyser);
        source.start(nextTime);
        nextTime += buffer.duration;

        document.getElementById('bufferStat').innerText = `Lag: ${Math.round((nextTime - audioCtx.currentTime) * 1000)}ms`;
    }

    function forceSync() {
        if(audioCtx) nextTime = audioCtx.currentTime; 
    }

    function restartEngine() {
        if(socket && socket.readyState === WebSocket.OPEN) {
            audioCtx.close().then(() => {
                const rate = parseInt(document.getElementById('rateSelect').value);
                audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: rate });
                analyser = audioCtx.createAnalyser();
                analyser.connect(audioCtx.destination);
                nextTime = audioCtx.currentTime;
            });
        }
    }

    function animate() {
        if(!analyser) return;
        const data = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(data);
        document.querySelectorAll('.bar').forEach((bar, i) => {
            bar.style.height = Math.max(4, data[i*2] / 3) + 'px';
        });
        requestAnimationFrame(animate);
    }
</script>

</body>
</html>
