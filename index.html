<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ Vapi Pro Monitor</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: #000; 
            color: white; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
        }

        .monitor-card { 
            background: #111; 
            padding: 2rem; 
            border-radius: 20px; 
            border: 1px solid #333; 
            width: 90%; 
            max-width: 420px; 
            text-align: center;
        }

        .visualizer {
            height: 60px;
            background: #222;
            margin: 20px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .bar {
            width: 6px;
            background: #4ade80;
            margin: 0 2px;
            height: 10px;
            border-radius: 4px;
            transition: height 0.1s ease;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: #333;
            color: #888;
            margin-bottom: 15px;
        }
        .status-badge.live { background: #dc2626; color: white; animation: pulse 2s infinite; }

        .latency-stat { font-size: 12px; color: #666; margin-top: 10px; font-family: monospace; }

        select {
            background: #222; color: white; border: 1px solid #444; padding: 10px; 
            width: 100%; margin-bottom: 15px; border-radius: 8px; outline: none;
        }

        button { 
            background: white; color: black; border: none; padding: 16px; 
            border-radius: 12px; font-weight: 700; font-size: 16px; width: 100%; cursor: pointer;
        }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="monitor-card">
    <div id="statusBadge" class="status-badge">DISCONNECTED</div>
    
    <h2 style="margin: 0 0 10px 0;">Vapi Realtime Monitor</h2>
    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
        Professional low-latency PCM decoder.
    </p>

    <div class="visualizer" id="visualizer">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        <div class="bar"></div><div class="bar"></div>
    </div>

    <label style="font-size: 12px; color: #888; display: block; text-align: left; margin-bottom: 5px;">Sample Rate (Hz)</label>
    <select id="rateSelect" onchange="updateAudioEngine()">
        <option value="24000" selected>24,000 Hz (Turbo/High Quality)</option>
        <option value="16000">16,000 Hz (Standard)</option>
        <option value="8000">8,000 Hz (Phone Line)</option>
        <option value="44100">44,100 Hz (Music)</option>
        <option value="48000">48,000 Hz (Max)</option>
    </select>

    <button id="btn" onclick="startEngine()">Start Listening</button>
    <div id="latencyStat" class="latency-stat">Latency: 0ms</div>
</div>

<script>
    let socket;
    let audioCtx;
    let nextTime = 0;
    let wssUrl = null;
    let analyser;
    let dataArray;
    let animationId;

    // 1. Get URL from Browser Link
    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        wssUrl = params.get('call');
        if (!wssUrl) {
            document.getElementById('btn').innerText = "âŒ No Link Detected";
            document.getElementById('btn').disabled = true;
        }
    };

    function startEngine() {
        if (!wssUrl) return;

        // Initialize Audio Context
        const rate = parseInt(document.getElementById('rateSelect').value);
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: rate });
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 32;
        analyser.connect(audioCtx.destination); // Connect analyser to speakers
        
        // Connect WebSocket
        socket = new WebSocket(wssUrl);
        socket.binaryType = "arraybuffer";

        // UI Updates
        const btn = document.getElementById('btn');
        btn.disabled = true;
        btn.innerText = "Connecting...";

        socket.onopen = () => {
            document.getElementById('statusBadge').innerText = "ðŸ”´ LIVE AUDIO";
            document.getElementById('statusBadge').classList.add("live");
            btn.innerText = "Listening...";
            animateVisualizer();
        };

        socket.onmessage = (event) => {
            if (event.data instanceof ArrayBuffer) {
                scheduleBuffer(event.data);
            }
        };

        socket.onclose = () => {
            document.getElementById('statusBadge').innerText = "CALL ENDED";
            document.getElementById('statusBadge').classList.remove("live");
            cancelAnimationFrame(animationId);
        };
    }

    // âš¡ THE MAGIC: Jitter Buffer & Drift Correction
    function scheduleBuffer(arrayBuffer) {
        // 1. Decode Raw PCM (Int16 -> Float32)
        const int16 = new Int16Array(arrayBuffer);
        const float32 = new Float32Array(int16.length);
        for (let i = 0; i < int16.length; i++) float32[i] = int16[i] / 32768;

        // 2. Create Audio Buffer
        const buffer = audioCtx.createBuffer(1, float32.length, audioCtx.sampleRate);
        buffer.getChannelData(0).set(float32);

        // 3. Jitter Correction Logic
        // If nextTime is in the past (we are lagging), jump to "now"
        if (nextTime < audioCtx.currentTime) {
            nextTime = audioCtx.currentTime + 0.05; // Add tiny buffer (50ms)
        }
        
        // If nextTime is TOO far in future (latency buildup), skip ahead
        // This is what fixes the "late" feeling
        if (nextTime > audioCtx.currentTime + 0.5) {
            console.log("Drift detected: Skipping ahead to sync");
            nextTime = audioCtx.currentTime + 0.05;
        }

        // 4. Play
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(analyser); // Connect to visualizer first, then speakers
        source.start(nextTime);
        
        // Advance time pointer
        nextTime += buffer.duration;

        // Update UI Latency Stat
        const latency = Math.round((nextTime - audioCtx.currentTime) * 1000);
        document.getElementById('latencyStat').innerText = `Buffer: ${latency}ms`;
    }

    function updateAudioEngine() {
        if(audioCtx) {
            audioCtx.close();
            nextTime = 0; // Reset drift
            startEngine(); // Restart with new rate
        }
    }

    // Optional: Simple Visualizer to prove audio is playing
    function animateVisualizer() {
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        const bars = document.querySelectorAll('.bar');
        
        function draw() {
            animationId = requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);
            
            // Update 5 bars based on frequency data
            for(let i=0; i<5; i++) {
                const height = Math.max(10, dataArray[i*2] / 2);
                if(bars[i]) bars[i].style.height = height + 'px';
            }
        }
        draw();
    }
</script>

</body>
</html>
